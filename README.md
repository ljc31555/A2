# AI视频生成系统

![Project Logo](assets/app_icon.png)

AI视频生成系统，集成文本转视频、AI配音、绘图设置、视频合成和批量处理等功能，支持商业化收费。基于PyQt5构建的现代化桌面应用，提供完整的AI驱动内容创作工作流。

## ✨ 功能特性

### 已实现功能 ✅
- **智能文本处理**
  - 基于多种AI模型（通义千问、Deepseek、智谱AI）的文章改写
  - 智能分段处理，支持超长文本的自动分割与处理
  - 多线程异步处理，提升用户体验
  - **状态稳定**：改写功能运行稳定，支持长文本处理
  
- **分镜脚本生成**
  - 将改写后的文章自动转换为专业视频分镜脚本
  - 支持场景描述、角色设定、动作指导等完整分镜要素
  - 智能解析已有分镜格式，支持手动编辑和AI生成混合工作流
  - **功能完善**：分镜生成逻辑稳定，支持复杂场景描述
  
- **AI绘图系统**
  - 集成ComfyUI工具，支持多种专业工作流（Flux、快手工作流等）
  - **提示词智能翻译**：自动将中文提示词翻译为英文，提升生图质量
  - 支持批量绘图和单张绘图两种模式
  - 可配置绘图参数（提示词、尺寸、采样步数、种子值、CFG等）
  - **图片保存优化**：修复重复保存问题，优化存储效率
  
- **图片管理系统**
  - 支持多张图片生成、选择、预览和管理
  - 备选图片功能，支持为每个分镜生成多个候选图片
  - 图片库功能，累积显示和管理所有生成的图片
  - 一键清空和批量操作支持
  - **路径管理优化**：智能图片路径检查，避免重复复制
  
- **用户界面优化**
  - 现代化PyQt5界面，支持多标签页工作流
  - 实时状态监控和进度显示
  - 智能表格显示，支持自动换行和列宽调整
  - 响应式布局，适配不同屏幕尺寸
  
- **项目管理系统**
  - 完整的项目文件管理，支持图片、音频、视频资源组织
  - 自动项目结构创建和维护
  - 项目数据持久化存储，支持项目加载和保存

### 开发中功能 🚧
- **AI配音系统**：集成TTS功能，支持多语言语音合成
  - 计划支持多种TTS引擎（Azure、百度、阿里云等）
  - 语音角色选择和语音参数调节
  - 分镜语音自动生成和同步
  
- **视频合成引擎**：使用FFmpeg和OpenCV进行专业级视频处理
  - 图片序列转视频功能
  - 音视频同步和时长控制
  - 转场效果和视频特效
  - 多种输出格式支持
  
- **批量处理系统**：支持大规模视频生成任务
  - 批量项目处理
  - 任务队列管理
  - 进度监控和错误恢复
  
- **商业化支持**：内置收费与试用机制
  - 用户账户系统
  - 使用次数限制
  - 付费功能解锁

## 🛠 技术栈

- **GUI框架**: PyQt5, PyQtWebEngine
- **AI模型集成**: 
  - LLM API支持：通义千问、Deepseek、智谱AI
  - 图像生成：ComfyUI集成，支持Flux、Kolors等模型
  - 文本处理：Transformers, Torch
- **图像处理**: 
  - ComfyUI工作流管理
  - Pillow图像处理
  - WebSocket实时通信
- **视频处理**: OpenCV, FFmpeg-python
- **音频处理**: FFmpeg, CosyVoice (计划中)
- **NLP处理**: SpaCy, Jieba
- **网络通信**: Requests, WebSockets
- **数据处理**: NumPy, JSON配置管理         

## 🚀 快速开始

### 安装依赖
```bash
pip install -r requirements.txt
```

### 配置API密钥
1. 编辑`config/llm_config.json`配置LLM模型
2. 根据需要配置通义千问、Deepseek或智谱AI的API密钥
3. 确保ComfyUI服务运行在默认端口8188

### 运行程序
```bash
python main.py
# 或
start.bat
```

## 📂 项目结构
```
AI_Video_Generator/
├── src/                    # 核心代码
│   ├── gui/                # 图形界面模块
│   │   ├── main_window.py  # 主窗口
│   │   ├── storyboard_tab.py # 分镜编辑界面
│   │   └── text_processing_threads.py # 异步处理线程
│   ├── models/             # AI模型管理
│   │   ├── llm_api.py      # LLM API封装
│   │   ├── comfyui_client.py # ComfyUI客户端
│   │   ├── text_parser.py  # 文本解析器
│   │   └── workflow_manager.py # 工作流管理
│   ├── video_processing/   # 视频合成（开发中）
│   ├── audio_processing/   # AI配音（开发中）
│   ├── batch_processing/   # 批量任务
│   ├── config/             # 配置管理
│   └── utils/              # 工具函数
├── assets/                 # 静态资源
│   ├── app_icon.png        # 应用图标
│   └── styles.qss          # 样式文件
├── config/                 # 配置文件
│   ├── llm_config.json     # LLM模型配置
│   ├── app_settings.json   # 应用设置
│   ├── tts_config.json     # TTS配置
│   └── workflows/          # ComfyUI工作流
├── logs/                   # 日志文件
├── requirements.txt        # Python依赖
├── main.py                 # 程序入口
└── start.bat              # Windows启动脚本
```

## 🖥 界面预览
*(可添加界面截图)*

## ⚙️ 配置说明
主要配置文件位于`config/`目录：
- `llm_config.json`: LLM模型配置（通义千问、Deepseek、智谱AI）
- `app_settings.json`: 应用系统参数配置
- `tts_config.json`: 文字转语音配置
- `workflows/`: ComfyUI工作流配置文件夹
- `projects/`: 项目文件存储目录

### LLM配置示例
```json
{
  "models": [
    {
      "name": "通义千问",
      "type": "tongyi",
      "key": "your-api-key",
      "url": "https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions"
    }
  ]
}
```

## 📝 使用指南

### 基本工作流程
1. **文章改写**：在主界面输入原始文章内容，选择AI模型进行改写
2. **生成分镜**：点击"生成分镜"按钮，AI自动将文章转换为分镜脚本
3. **配置绘图**：在工作流面板选择绘图工作流，设置提示词、尺寸等参数
4. **智能翻译**：系统自动将中文提示词翻译为英文，提升ComfyUI生图质量
5. **生成图片**：点击分镜列表中的"绘图"按钮，为每个分镜生成对应图片
6. **图片管理**：在图片库中预览、选择和管理生成的图片，支持备选图片功能
7. **批量处理**：支持批量绘图，一键为所有分镜生成图片
8. **导出内容**：保存分镜脚本和图片资源（视频合成功能开发中）

### 新功能亮点
- **提示词智能翻译**：自动检测中文提示词并翻译为英文，无需手动翻译
- **多模型支持**：支持通义千问、Deepseek、智谱AI等多种LLM模型
- **工作流管理**：支持Flux、快手工作流等多种ComfyUI工作流
- **异步处理**：多线程处理，界面响应流畅，支持长时间任务

### 注意事项
- **ComfyUI服务**：确保ComfyUI服务正常运行（默认端口8188）
- **显存要求**：快手工作流需要较大显存（建议8GB以上），显存不足时请选择Flux等轻量工作流
- **API配置**：使用提示词翻译功能前，请确保在`config/llm_config.json`中正确配置LLM API密钥
- **网络连接**：文本改写、分镜生成和提示词翻译功能需要稳定的网络连接
- **状态监控**：底部状态栏会实时显示操作进度和结果信息
- **错误处理**：如遇到翻译失败，系统会自动回退到原始中文提示词，不影响图片生成

## 🐛 常见问题

**Q: 提示词翻译功能不工作怎么办？**
A: 请检查`config/llm_config.json`中的API配置是否正确，确保API密钥有效且网络连接正常

**Q: 如何选择合适的工作流？**
A: 根据显存大小选择：8GB以下建议使用Flux工作流，8GB以上可使用快手工作流

**Q: 分镜表格显示不全怎么办？**
A: 已默认启用自动换行和列宽调整，可手动拖拽调整列宽

**Q: ComfyUI连接失败怎么办？**
A: 确保ComfyUI服务在8188端口正常运行，检查防火墙设置

**Q: 批量绘图时程序卡顿怎么办？**
A: 这是正常现象，系统使用多线程处理，请耐心等待，可在状态栏查看进度

**Q: 备选图片不显示怎么办？**
A: 这是已知问题，已在最新版本中修复，确保使用最新代码

## 🔧 已解决问题
- ✅ **图片重复保存问题修复**：解决了图片在生成后被多次复制到项目目录的问题（2025-06-06）
  - 问题原因：多个地方调用图片复制逻辑，导致同一张图片被重复保存
  - 解决方案：添加智能路径检查，如果图片已在项目目录则直接使用
  - 涉及文件：project_manager.py、ai_drawing_tab.py、main_window.py
  - 效果：提高存储效率，避免磁盘空间浪费
  
- ✅ **提示词翻译功能修复**：修复了LLM API调用错误的问题（2025-02-02）
  - 问题原因：`comfyui_client.py`中错误调用了不存在的`_call_api`方法
  - 解决方案：修正为正确的`_make_api_call`方法调用
  - 现在支持自动将中文提示词翻译为英文，提升ComfyUI生图质量
  
- ✅ **底部状态栏显示问题**：修复了状态栏不显示操作状态的问题
  - 解决方案：禁用自动日志刷新，增加状态栏高度，确保组件可见性
  - 现在点击绘图按钮会立即显示"正在生图"状态，完成后显示结果
  
- ✅ **快手工作流显存不足**：识别并解决了Kolors模型显存需求过高的问题
  - 问题原因：快手工作流使用ChatGLM3、Kolors UNET等大型模型组件
  - 解决方案：建议用户根据硬件配置选择合适的工作流
  
- ✅ **行索引超出范围错误**：修复了图片更新时表格行数与数据不同步的问题
  - 问题原因：在更新分镜图片时，表格行数为0而分镜数据不为空，导致索引越界
  - 解决方案：在更新图片前添加表格同步检查，确保表格行数与分镜数据一致
  - 涉及文件：main_window.py、storyboard_tab.py
  
- ✅ **备选图片追加功能**：修复了备选图片栏只替换而不追加新图片的问题
  - 问题原因：图片生成完成后使用替换逻辑而不是追加逻辑更新备选图片
  - 解决方案：改为追加模式，支持多个备选图片同时显示，统一使用逗号分隔符
  - 涉及文件：main_window.py、shots_window.py

## 🔧 待解决问题
- **界面稳定性**: ComfyUI图片生成完成后分镜列表界面消失问题（已临时修复）
  - 临时方案：注释掉自动界面切换逻辑
  - 优先级：低（不影响核心功能使用）
  
## 🎯 下一阶段开发计划
- **AI配音功能**：集成TTS引擎，实现文本转语音
- **视频合成功能**：将图片和音频合成为完整视频
- **批量处理优化**：提升大规模任务处理效率
- **用户体验优化**：界面交互和性能优化

## 🤝 贡献指南
欢迎提交Pull Request，请遵循以下规范：
1. 创建功能分支 (`feature/xxx`)
2. 提交清晰的commit message
3. 更新开发文档 (`development_guidelines.txt`)

## 📜 许可证
MIT License

## 📅 更新日志
- 2025-06-06: 图片保存逻辑优化与重复保存问题修复
  - **重大优化**：修复图片重复保存问题，提升存储效率
    - 问题：图片在生成后被多个地方重复复制到项目目录
    - 解决：在project_manager.py中添加add_image_to_project方法，统一图片管理
    - 优化：在ai_drawing_tab.py和main_window.py中添加路径检查逻辑
    - 效果：避免重复保存，确保主图和备选图引用同一张图片
  - 核心功能稳定性确认：改写、生成分镜、生成图片功能运行稳定
  - 为后续AI配音和视频合成功能开发做好准备
  
- 2025-02-02: 提示词翻译功能修复与表格同步优化
  - **重大修复**：修复提示词翻译功能中的LLM API调用错误
    - 问题：`comfyui_client.py`中错误调用不存在的`_call_api`方法导致`AttributeError`
    - 解决：修正为正确的`_make_api_call`方法调用
    - 影响：现在可以正常使用中文提示词自动翻译为英文功能，显著提升ComfyUI生图质量
  - 表格同步与备选图片功能修复
  - 修复行索引超出范围错误：解决图片更新时表格行数与分镜数据不同步问题
  - 在main_window.py和storyboard_tab.py的update_shot_image方法中添加表格同步检查机制
  - 修复备选图片追加功能：改变备选图片更新逻辑从替换模式改为追加模式
  - 统一备选图片分隔符格式，使用逗号替代分号，确保多个备选图片正确显示
  - 添加重复图片检查机制，避免同一图片被重复添加到备选列表
  - 增强错误处理和日志记录，提升系统稳定性和可调试性
- 2025-02-01: 底部状态栏显示修复与快手工作流问题解决
  - 修复底部状态栏不显示操作状态的问题：禁用自动日志刷新功能，避免覆盖用户操作状态
  - 增加状态栏组件高度和可见性设置，确保状态信息正常显示
  - 解决快手工作流显存不足问题：识别Kolors模型显存需求，提供工作流选择建议
  - 优化用户体验：点击绘图按钮立即显示"正在生图"状态，完成后显示成功或失败信息
  - 状态信息持久显示，不再被自动刷新覆盖
- 2025-01-31: 异常处理优化与界面稳定性修复
  - 修复storyboard_tab.py文件中的语法错误：补全try语句的except子句，修复括号未闭合问题
  - 增强KeyboardInterrupt异常处理：在llm_api.py、text_parser.py和storyboard_tab.py中添加用户中断处理
  - 解决程序因用户中断而崩溃的问题，提升程序稳定性
  - 已知问题：ComfyUI图片生成完成后分镜列表界面仍会消失，需进一步排查界面切换逻辑
  - 临时修复：注释掉populate_shots_table方法中的switch_to_shots_table_view调用，防止界面自动切换
- 2025-01-30: 工作流配置界面优化与种子值功能修复
  - 优化工作流配置界面：移除prompt和guidance参数，添加种子值设置控件
  - 增加工作流参数配置区域高度至350px，改善界面显示效果
  - 修复种子值随机功能：解决用户设置的种子值无法传递给ComfyUI的问题
  - 在workflow_manager.py中添加seed和noise_seed参数处理逻辑
  - 支持固定种子值和随机种子值切换，用户可自由控制图像生成的随机性
  - 兼容多种工作流类型：支持传统seed参数和Flux工作流的noise_seed参数
- 2025-01-01: 界面优化与进度条功能增强
  - 为绘图设置功能添加进度条显示，提升用户体验
  - 优化分镜列表显示：修复表格列宽自适应问题，改善文本换行效果
  - 调整图片显示尺寸：主图片列增大至200x150，备选图片列调整为120x80
  - 优化表格列宽设置：图片列220px，备选图片列140px，操作列100px
  - 增加表格行高至160px，确保图片完整显示
  - 已知问题：备选图片栏中第二次生成的图片仍无法正常显示，需进一步排查
- 2024-12-31: 重大更新：绘图设置功能全面升级
  - 修复ComfyUI API调用流程，解决图片生成失败问题
  - 实现图片库功能，支持多张图片累积显示
  - 添加图片选择与管理功能，支持点击选择和一键清空
  - 优化用户界面，采用网格布局展示生成的图片
  - 修复提示词不生效问题，确保用户输入的描述正确传递
- YYYY-MM-DD: 修复text_parser.py缺少json导入
- YYYY-MM-DD: 优化分镜表格显示
- YYYY-MM-DD: 修复shots_window.py的QHeaderView问题